<!doctype html>
<html lang="th">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Balancing Act — PHX</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg:#0b0f14; --panel:#0f1620; --panel2:#121c29; --border:#1d2a3a;
    --text:#c7d2e0; --muted:#7f91a8; --primary:#9cff6a; --accent:#7ae0ff; --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1100px 560px at 70% -10%,#0e1825 0%,transparent 60%),var(--bg);
    color:var(--text); font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
  }
  a{color:var(--accent); text-decoration:none}
  .wrap{max-width:1100px; margin:24px auto; padding:0 16px}

  .top{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px}
  .pill{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border:1px solid var(--border); border-radius:999px;
        background:linear-gradient(180deg,var(--panel),var(--panel2)); color:#93a6be}
  h1{margin:0; font-size:18px}

  .grid{display:grid; gap:16px; grid-template-columns: 1fr 260px}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

  .panel{
    border:1px solid var(--border);
    background:linear-gradient(180deg,var(--panel),var(--panel2));
    border-radius:var(--radius);
    padding:14px;
  }

  /* Board */
  #board{position:relative; height:520px; background:linear-gradient(#0e2030 0 64%, #1b8030aa 64% 100%); border-radius:12px}
  .ground{position:absolute; left:0; right:0; bottom:0; height:36%; background:linear-gradient(#1b803044,#1b803000); border-bottom-left-radius:12px; border-bottom-right-radius:12px}

  /* pivot + beam */
  .pivot { position:absolute; left:50%; bottom:160px; transform:translateX(-50%); width:28px; height:120px; background:#2b3a4c; border:1px solid #375068; border-radius:6px; }
  .pivot:after{ content:""; position:absolute; top:-10px; left:50%; transform:translateX(-50%); width:18px; height:18px; border-radius:50%; background:#cbd6e2; border:2px solid #7a8da6; }

  .beam-wrap{ position:absolute; left:50%; bottom:220px; transform:translateX(-50%) rotate(0deg); transform-origin:50% 20px; transition:transform .15s ease-out; }
  .beam{ width:720px; height:20px; background:#d3aa72; border:2px solid #8a6b3f; border-radius:8px; position:relative; overflow:visible; }
  .slot-mark{ position:absolute; top:2px; width:2px; height:16px; background:#6e5736aa; opacity:.7; transition:opacity .15s }
  .slots-hidden .slot-mark{ opacity:.15 }          /* จางลงเมื่อเป็นโหมด Free */

  /* masses */
  .mass{ width:44px; height:44px; border-radius:8px; color:#091018; display:flex; align-items:center; justify-content:center; font-weight:800;
         border:2px solid #1b2a3a; box-shadow:0 6px 16px #0008; position:absolute; cursor:grab; user-select:none; }
  .mass[data-mass="1"]{background:#c7ebff}
  .mass[data-mass="2"]{background:#9dd6ff}
  .mass[data-mass="5"]{background:#7ae0ff}
  .mass[data-mass="10"]{background:#9cff6a}
  .ghost{opacity:.45; filter:saturate(.5)}

  /* Palette */
  .card h3{margin:0 0 8px 0; color:#9ab3cf; text-transform:uppercase; font-size:12px; letter-spacing:.6px}
  .palette{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
  .palette .mass{position:relative; static:initial; border:1px dashed #2b405b; box-shadow:none; width:56px; height:56px; cursor:grab}
  .palette .mass span{pointer-events:none}
  .note{color:#93a6be; font-size:12px; margin-top:8px}

  /* HUD */
  .hud{position:absolute; left:14px; top:14px; display:flex; gap:12px; font-size:12px; color:#a8bdd6}
  .hud .pill{padding:6px 10px}

  /* Mode bar (เหมือนปุ่มในรูป) */
  .modebar{
    position:absolute; left:50%; bottom:14px; transform:translateX(-50%);
    display:flex; align-items:center; gap:10px;
    background:linear-gradient(180deg,#0f1b28,#0b131c); border:1px solid #233447;
    border-radius:14px; padding:10px 12px; box-shadow:0 8px 20px #0006;
  }
  .mode-icon{
    width:120px; height:56px; border-radius:10px; border:1px solid #1f2f41;
    display:flex; align-items:center; justify-content:center; font-size:13px; color:#a8bdd6; opacity:.85;
    background:linear-gradient(#19324a,#0f1f31);
  }
  .mode-icon.active{ outline:2px solid #59b6ff55; opacity:1 }
  .toggle{
    width:64px; height:28px; border-radius:999px; background:#0b141f; border:1px solid #223240; position:relative;
  }
  .knob{
    position:absolute; top:2px; left:2px; width:24px; height:24px; border-radius:50%;
    background:#dce9f7; box-shadow:0 2px 6px #0006; transition:left .15s;
  }
  .free .knob{ left:38px; }
</style>

<div class="wrap">
  <div class="top">
    <span class="pill">PHX • Mechanics</span>
    <h1>Balancing Act (Web)</h1>
    <a class="pill" href="../index.html">← Back to Catalog</a>
  </div>

  <div class="grid">
    <!-- Board -->
    <div class="panel" id="boardPanel">
      <div id="board">
        <div class="hud">
          <span class="pill">Torque L: <b id="tL">0</b></span>
          <span class="pill">Torque R: <b id="tR">0</b></span>
          <span class="pill">Angle: <b id="ang">0°</b></span>
        </div>

        <div class="beam-wrap" id="beamWrap">
          <div class="beam" id="beam"></div>
        </div>
        <div class="pivot"></div>
        <div class="ground"></div>

        <!-- Mode bar -->
        <div id="modeBar" class="modebar">
          <div id="icoSnap" class="mode-icon active" title="Snap to slots">Snap</div>
          <div id="toggle" class="toggle"><div class="knob"></div></div>
          <div id="icoFree" class="mode-icon" title="Free placement">Free</div>
        </div>
      </div>
    </div>

    <!-- Palette -->
    <aside class="panel">
      <h3>Mass Palette</h3>
      <div class="palette" id="palette">
        <div class="mass" data-mass="1"><span>1 kg</span></div>
        <div class="mass" data-mass="2"><span>2 kg</span></div>
        <div class="mass" data-mass="5"><span>5 kg</span></div>
        <div class="mass" data-mass="10"><span>10 kg</span></div>
      </div>
      <div class="note">โหมด <b>Snap</b> จะล็อกวัตถุเข้าขีดบนคาน • โหมด <b>Free</b> วางอิสระ</div>
      <div class="note">ลากก้อนที่อยู่บนคานออกนอกคาน เพื่อเอาออก</div>
    </aside>
  </div>
</div>

<script>
/* ==== Elements & Const ==== */
const beamWrap = document.getElementById('beamWrap');
const beam = document.getElementById('beam');
const palette = document.getElementById('palette');
const modeBar = document.getElementById('modeBar');
const icoSnap = document.getElementById('icoSnap');
const icoFree = document.getElementById('icoFree');
const toggle = document.getElementById('toggle');

const tL = document.getElementById('tL');
const tR = document.getElementById('tR');
const ang = document.getElementById('ang');

const SLOT_PX = 28;
const SLOT_COUNT = 12;     // ตำแหน่ง -12..+12
const MASS_Y = -52;        // ยกเหนือแนวคานเล็กน้อย
const MAX_ANGLE = 15;
const TORQUE_TO_ANGLE = 0.9;

const wrapRect  = () => beamWrap.getBoundingClientRect();

let snapMode = true;       // ค่าเริ่มต้น: Snap
const onBeam = [];         // {el, mass, slotIndex?, x?, y?}

/* ==== วาดขีด slot บนคาน ==== */
(function drawSlots(){
  const cx = beam.clientWidth/2;
  for (let i=-SLOT_COUNT;i<=SLOT_COUNT;i++){
    const d = document.createElement('div');
    d.className = 'slot-mark';
    d.style.left = (cx + i*SLOT_PX - 1) + 'px';
    beam.appendChild(d);
  }
})();

/* ==== Helpers ==== */
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const nearestSlot = clientX=>{
  const r = wrapRect();
  const x = clientX - r.left;
  const cx = beam.clientWidth/2;
  return clamp(Math.round((x - cx)/SLOT_PX), -SLOT_COUNT, SLOT_COUNT);
};
const slotXpx = idx => beam.clientWidth/2 + idx*SLOT_PX;

function recalc(){
  let L=0,R=0;
  onBeam.forEach(o=>{
    let idx;
    if (snapMode && typeof o.slotIndex==='number') {
      idx = o.slotIndex;
    } else {
      const cx = beam.clientWidth/2;
      idx = (o.x - cx)/SLOT_PX; // ตีความเป็นช่องทศนิยม
    }
    if (idx<0) L += o.mass * Math.abs(idx);
    else if (idx>0) R += o.mass * Math.abs(idx);
  });
  tL.textContent = L.toFixed(2);
  tR.textContent = R.toFixed(2);
  const theta = clamp((R-L)*TORQUE_TO_ANGLE, -MAX_ANGLE, MAX_ANGLE);
  ang.textContent = theta.toFixed(1)+'°';
  beamWrap.style.transform = `translateX(-50%) rotate(${theta}deg)`;
}

/* ==== Drag & Drop ==== */
let dragging=null; // { el, mass, fromPalette, fromBeamObj? }

function createMassEl(mass){
  const el = document.createElement('div');
  el.className = 'mass';
  el.dataset.mass = mass;
  el.innerHTML = `<span>${mass} kg</span>`;
  return el;
}
function startDragFromPalette(src){
  const mass = +src.dataset.mass;
  const el = createMassEl(mass);
  el.classList.add('ghost');
  document.body.appendChild(el);
  dragging = {el, mass, fromPalette:true};
}
function startDragFromBeam(obj){
  const ghost = createMassEl(obj.mass);
  ghost.classList.add('ghost');
  document.body.appendChild(ghost);
  dragging = {el:ghost, mass:obj.mass, fromPalette:false, fromBeamObj:obj};
  beamWrap.removeChild(obj.el);
  const i = onBeam.indexOf(obj);
  if (i>=0) onBeam.splice(i,1);
  recalc();
}
function onMouseMove(e){
  if(!dragging) return;
  const el = dragging.el;
  el.style.position='fixed';
  el.style.left = (e.clientX - el.offsetWidth/2)+'px';
  el.style.top  = (e.clientY - el.offsetHeight/2)+'px';
}
function cancelDrag(){
  if(!dragging) return;
  dragging.el.remove();
  dragging=null;
}
function finishDrag(e){
  if(!dragging) return;
  const r = wrapRect();
  const inside = (e.clientX>=r.left && e.clientX<=r.right &&
                  e.clientY>=r.top-80 && e.clientY<=r.bottom+40);
  if(inside){
    let placed = dragging.fromPalette ? createMassEl(dragging.mass)
                                      : dragging.fromBeamObj.el;
    placed.style.position='absolute';
    placed.style.transform='translate(-50%,-50%)';

    let ref;
    if (snapMode){
      const idx = nearestSlot(e.clientX);
      placed.style.left = (slotXpx(idx))+'px';
      placed.style.bottom = (20 - MASS_Y)+'px';
      placed.style.top = '';
      ref = { el: placed, mass: dragging.mass, slotIndex: idx };
    } else {
      const x=e.clientX - r.left;
      const y=e.clientY - r.top;
      placed.style.left = x+'px';
      placed.style.top  = y+'px';
      placed.style.bottom = '';   // ใช้ top ในโหมด Free
      ref = { el: placed, mass: dragging.mass, x, y };
    }

    placed.onmousedown = ()=>{ startDragFromBeam(ref); bindHandlers(); };
    beamWrap.appendChild(placed);
    onBeam.push(ref);
    recalc();
  }
  cancelDrag();
}
function bindHandlers(){
  document.addEventListener('mousemove', onMouseMove);
  document.addEventListener('mouseup', ev=>{
    document.removeEventListener('mousemove', onMouseMove);
    finishDrag(ev);
  }, {once:true});
}

/* Palette events */
palette.querySelectorAll('.mass').forEach(m=>{
  m.addEventListener('mousedown', ()=>{
    startDragFromPalette(m);
    bindHandlers();
  });
});
beamWrap.addEventListener('mousedown', e=>{
  const el = e.target.closest('.mass');
  if(!el) return;
  const obj = onBeam.find(o=>o.el===el);
  if(!obj) return;
  startDragFromBeam(obj);
  bindHandlers();
});

/* ==== Mode toggle ==== */
function setMode(isSnap){
  snapMode = isSnap;
  modeBar.classList.toggle('free', !isSnap);
  icoSnap.classList.toggle('active', isSnap);
  icoFree.classList.toggle('active', !isSnap);
  beam.classList.toggle('slots-hidden', !isSnap);
  recalc();
}
toggle.addEventListener('click', ()=> setMode(!snapMode));
icoSnap.addEventListener('click', ()=> setMode(true));
icoFree.addEventListener('click', ()=> setMode(false));

/* Init */
window.addEventListener('resize', recalc);
setMode(true);   // เริ่มที่ Snap
recalc();
</script>
</html>
